{% include "partial/header.html" %}
{% include "partial/search.html" %}


<div class="px-4 flex justify-center gap-4">
    <button
            id="reloadBtn"
            class="bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition"
    >
        üîÅ Reload from Disk
    </button>

    <button
            id="syncBtn"
            class="bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition"
    >
        üîó Sync from Civitai
    </button>
</div>


<!-- Main content section -->
<main id="main-content" class="px-4 py-6">
    <div id="loadingSpinner">
        <div class="flex justify-center py-10">
            <svg class="animate-spin h-8 w-8 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                 viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
            </svg>
        </div>
    </div>

    <div class="flex justify-start items-center my-4">
        <div id="paginationTop" class="inline-flex flex-wrap items-center gap-1"></div>
    </div>

    <div id="grid" class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <div class="hidden relative bg-gray-900 border border-gray-700 rounded-lg overflow-hidden shadow-md">
            <a href="" class="block">
                <img src="" alt="" class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">
                <div class="p-4">
                    <h2 class="text-lg font-semibold truncate"></h2>
                </div>
            </a>
        </div>
    </div>

    <div class="flex justify-start items-center my-4">
        <div id="paginationBottom" class="inline-flex flex-wrap items-center gap-1"></div>
    </div>

</main>


<script>
    const loading = document.getElementById("loading");
    const grid = document.getElementById("grid");

    function showLoading(show) {
        const spinner = document.getElementById("loadingSpinner");
        spinner.classList.toggle("hidden", !show);
    }

    function getApiUrl() {
        const path = window.location.pathname;
        const search = window.location.search;
        return "/api" + (path === "/" ? "" : path) + search;
    }

    function renderPagination(currentPage, totalItems, folder, count) {
        const totalPages = Math.max(1, Math.ceil(totalItems / count));
        const top = document.getElementById("paginationTop");
        const bottom = document.getElementById("paginationBottom");
        top.innerHTML = bottom.innerHTML = "";

        const makeBtn = (label, page, disabled = false, isActive = false) => {
            const btn = document.createElement("a");
            btn.textContent = label;
            btn.href = `/?folder=${folder}&page=${page}&count=${count}`;
            btn.className =
                "px-3 py-1 mx-1 rounded text-sm " +
                (disabled
                    ? "bg-gray-300 text-gray-500 pointer-events-none"
                    : isActive
                        ? "bg-gray-800 text-white font-bold"
                        : "bg-blue-600 text-white hover:bg-blue-700 transition");
            return btn;
        };

        const createPagination = (container) => {
            container.appendChild(makeBtn("First", 1, currentPage === 1));
            container.appendChild(makeBtn("Prev", Math.max(1, currentPage - 1), currentPage === 1));

            const range = 2; // how many pages before/after current
            const start = Math.max(1, currentPage - range);
            const end = Math.min(totalPages, currentPage + range);

            if (start > 2) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            for (let i = start; i <= end; i++) {
                container.appendChild(makeBtn(i, i, false, i === currentPage));
            }

            if (end < totalPages - 1) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            container.appendChild(makeBtn("Next", Math.min(totalPages, currentPage + 1), currentPage === totalPages));
            container.appendChild(makeBtn("Last", totalPages, currentPage === totalPages));
        };

        createPagination(top);
        createPagination(bottom);
    }

    async function fetchAndRenderItems() {
        showLoading(true);

        try {
            const res = await fetch(getApiUrl());
            const data = await res.json();

            if (data.err) throw new Error(data.err);

            showLoading(false);
            grid.innerHTML = "";

            data.items.forEach(item => {
                const card = document.createElement("div");
                card.className = "relative bg-gray-900 border border-gray-700 rounded-lg overflow-hidden shadow-md";
                const link = item.is_dir ? `/?folder=${item.id}` : `/item/${item.id}`;
                card.innerHTML = `
                  <a href="${link}" class="block">
                    <img src="${item.preview}" alt="${item.name}" class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">
                        <div class="p-4">
                            <h2 class="text-lg font-semibold truncate">${item.name}</h2>
                        </div>
                  </a>
                `;

                grid.appendChild(card);
            });

            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get("page") || "1");
            const folder = params.get("folder") || "";
            const count = parseInt(params.get("count") || "20");

            renderPagination(page, data.total, folder, count);

        } catch (err) {
            grid.innerHTML = `<p class="text-red-400 text-center py-10">Failed to load items: ${err.message}</p>`;
        }

    }

    // Initial load
    fetchAndRenderItems();
</script>

<script>
    async function callAndRefresh(endpoint) {
        try {
            showLoading(true);
            await fetch(endpoint); // GET request
            await fetchAndRenderItems();   // Refresh grid
        } catch (err) {
            console.error(`Failed to call ${endpoint}`, err);
        } finally {
            showLoading(false);
        }
    }

    document.getElementById("reloadBtn").addEventListener("click", () => {
        callAndRefresh("/api/reload_from_disk");
    });

    document.getElementById("syncBtn").addEventListener("click", () => {
        callAndRefresh("/api/sync_civitai");
    });
</script>

</body>
</html>

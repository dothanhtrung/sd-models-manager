<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/tailwind_output.css" rel="stylesheet">
    <title>Stable Diffusion Models Manager</title>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto px-4 py-6">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-2">
        <h1 class="text-3xl font-bold">Stable Diffusion Models Manager</h1>
        <div class="space-x-2">
            <button
                    id="reloadBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                üîÅ Reload from Disk
            </button>
            <button
                    id="syncBtn"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                üîó Sync from Civitai
            </button>
        </div>
    </div>

    <div class="flex justify-start items-center my-4">
        <div id="paginationTop" class="inline-flex flex-wrap items-center gap-1"></div>
    </div>

    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- Cards will be inserted here -->
    </div>

    <div class="flex justify-start items-center my-4">
        <div id="paginationBottom" class="inline-flex flex-wrap items-center gap-1"></div>
    </div>


    <!-- Corner Loading Spinner -->
    <div id="loadingSpinner" class="fixed top-4 right-4 z-50 hidden">
        <div class="animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
    </div>
</div>


<script>
    function renderPagination(currentPage, totalItems, folder, count) {
        const totalPages = Math.max(1, Math.ceil(totalItems / count));
        const top = document.getElementById("paginationTop");
        const bottom = document.getElementById("paginationBottom");
        top.innerHTML = bottom.innerHTML = "";

        const makeBtn = (label, page, disabled = false, isActive = false) => {
            const btn = document.createElement("a");
            btn.textContent = label;
            btn.href = `/?folder=${folder}&page=${page}&count=${count}`;
            btn.className =
                "px-3 py-1 mx-1 rounded text-sm " +
                (disabled
                    ? "bg-gray-300 text-gray-500 pointer-events-none"
                    : isActive
                        ? "bg-gray-800 text-white font-bold"
                        : "bg-blue-600 text-white hover:bg-blue-700 transition");
            return btn;
        };

        const createPagination = (container) => {
            container.appendChild(makeBtn("First", 1, currentPage === 1));
            container.appendChild(makeBtn("Prev", Math.max(1, currentPage - 1), currentPage === 1));

            const range = 2; // how many pages before/after current
            const start = Math.max(1, currentPage - range);
            const end = Math.min(totalPages, currentPage + range);

            if (start > 2) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            for (let i = start; i <= end; i++) {
                container.appendChild(makeBtn(i, i, false, i === currentPage));
            }

            if (end < totalPages - 1) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            container.appendChild(makeBtn("Next", Math.min(totalPages, currentPage + 1), currentPage === totalPages));
            container.appendChild(makeBtn("Last", totalPages, currentPage === totalPages));
        };

        createPagination(top);
        createPagination(bottom);
    }


    async function fetchModels() {
        try {
            const query = window.location.search;
            const apiUrl = `/api/get${query}`;
            const res = await fetch(apiUrl);
            const data = await res.json();

            const items = data.items;
            if (!Array.isArray(items)) throw new Error("Expected `items` to be an array");

            const grid = document.getElementById("grid");
            grid.innerHTML = "";

            items.forEach(model => {
                const card = document.createElement("div");
                const href = model.is_dir ? `/?folder=${model.id}` : `/item/${model.id}`;
                card.className = "relative bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow";


                card.innerHTML = `
                    <a href="${href}" class="block">
                  <img src="${model.preview}" alt="${model.name}" class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">
                  <div class="p-4">
                    <h2 class="text-lg font-semibold truncate">${model.name}</h2>
                  </div>
                  </a>
                `;

                grid.appendChild(card);
            });

            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get("page") || "1");
            const folder = params.get("folder") || "";
            const count = parseInt(params.get("count") || "20");

            renderPagination(page, data.total, folder, count);
        } catch (err) {
            document.getElementById("grid").innerHTML = `<p class="text-red-600">Failed to load models.</p>`;
            console.error(err);
        }
    }

    fetchModels();


</script>


<script>
    function showLoading(show) {
        const spinner = document.getElementById("loadingSpinner");
        spinner.classList.toggle("hidden", !show);
    }

    async function callAndRefresh(endpoint) {
        try {
            showLoading(true);
            await fetch(endpoint); // GET request
            await fetchModels();   // Refresh grid
        } catch (err) {
            console.error(`Failed to call ${endpoint}`, err);
        } finally {
            showLoading(false);
        }
    }

    document.getElementById("reloadBtn").addEventListener("click", () => {
        callAndRefresh("/api/reload_from_disk");
    });

    document.getElementById("syncBtn").addEventListener("click", () => {
        callAndRefresh("/api/sync_civitai");
    });
</script>


</body>
</html>
